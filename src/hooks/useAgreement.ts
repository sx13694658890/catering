import { ref } from 'vue'

export type AgreementType = 'privacy' | 'service' | 'signService'

// 压缩协议内容的默认块级间距，统一行高，避免 <p>/<h3>/<ul>/<li> 间距过大
function compactHtml(html: string) {
  const styleMap: Record<string, string> = {
    div: 'margin:0;padding-top:1px;overflow:hidden;font-size:14px;line-height:1.6;word-break:break-word;',
    p: 'margin:0 0 6px;line-height:1.6;',
    h2: 'margin:6px 0 4px;line-height:1.5;font-weight:600;font-size:18px;',
    h3: 'margin:1px 0 4px;line-height:1.5;font-weight:600;font-size:16px;',
    h4: 'margin:1px 0 3px;line-height:1.4;font-weight:600;font-size:15px;',
    h5: 'margin:1px 0 2px;line-height:1.4;font-weight:600;font-size:14px;',
    ul: 'margin:0 0 1px;padding-left:1.2em;',
    ol: 'margin:0 0 1px;padding-left:1.2em;;line-height:1.5;',
    li: 'margin:0 0 1px;line-height:1.5;',
  }

  const inject = (tag: string) => {
    const re = new RegExp(`<${tag}([^>]*)>`, 'gi')
    html = html.replace(re, (m, attrs) => {
      if (/style\s*=/.test(attrs)) {
        // 合并已有 style

        return m.replace(/style\s*=\s*(["'])(.*?)\1/i, (_s, q, val) => {
          const merged = `${val};${styleMap[tag]}`
          return `style=${q}${merged}${q}`
        })
      }
      return `<${tag}${attrs} style="${styleMap[tag]}">`
    })
  }

  ;['div', 'h2', 'p', 'h3', 'h4', 'h5', 'ul', 'ol', 'li'].forEach(inject)
  return html
}

function getPrivacyPolicyHtml() {
  return compactHtml(`
  <div class="privacy-policy" style="margin:0;padding: 0;">
    <h2 style="text-align: center;">小程序用户隐私政策</h2>
    <h3>第一章 总则</h3>
    <p>我们，[您的公司/开发者名称]（以下简称“我们”或“公司”），深知个人信息对您的重要性，并会尽全力保护您的个人信息安全可靠。我们致力于维持您对我们的信任，恪守以下原则，保护您的个人信息：权责一致原则、目的明确原则、选择同意原则、最少够用原则、确保安全原则、主体参与原则、公开透明原则。</p>
    <p>同时，我们承诺，我们将按业界成熟的安全标准，采取相应的安全保护措施来保护您的个人信息。</p>
    <h3>第二章 个人信息的收集和使用</h3>
    <h4>一、 我们如何收集和使用您的个人信息</h4>
    <p>在您使用我们的小程序服务时，我们可能会根据业务功能的需要，收集、存储和使用下列与您有关的信息。如果您不提供相关信息，可能无法享受我们提供的某些服务，或者无法达到相关服务拟达到的效果。</p>
    <h4>1. 用户手机号码的获取与使用</h4><h5>（1）获取方式与场景</h5>
    <p>当您在使用我们的小程序过程中，需要进行用户身份验证、安全校验、订单交付、会员服务或重要信息通知（例如：登录注册、收货地址管理、购买商品/服务、接收订单状态、参与会员活动等）时，您可以选择通过微信提供的 <code>&lt;button open-type="getPhoneNumber"&gt;</code> 组件授权我们获取您的手机号码。</p>
    <h5>（2）技术实现流程</h5>
    <ol>
      <li>当您点击授权按钮后，微信会先向您展示明确的授权弹窗，告知您我们将获取您的手机号，并由您主动点击“同意”进行授权。</li>
      <li>您授权后，微信会向我们返回一个动态的临时凭证（code）。</li>
      <li>我们将这个临时凭证（code）与您的用户登录凭证（code）一同提交至我们自己的服务器后端。</li>
      <li>我们的服务器后端通过调用微信提供的 <code>phonenumber.getPhoneNumber</code> 接口，凭借临时凭证换取您的加密手机号码。</li>
      <li>我们的服务器对加密数据进行解密，最终获得您的手机号码。</li>
    </ol>
    <p><strong>请注意：</strong>整个过程中，您的明文手机号不会在小程序前端（即您的手机设备上）暴露，而是由我们的服务端安全地处理，这极大地保障了您的信息安全。</p>
    <h5>（3）使用目的与法律依据</h5>
    <ul>
      <li>用于创建您的专属账户并与您的微信账号关联，以便为您提供持续的服务。</li>
      <li>用于履行与您达成的合同，例如向您发送订单确认、物流信息、服务变更等重要通知。</li>
      <li>用于保障您的账户安全，进行身份验证和风险检测。</li>
      <li>用于提供您主动选择的特定会员服务，如积分、优惠券等。</li>
    </ul>
    <p><strong>法律依据：</strong>处理您的手机号码是基于您的明确同意（即您点击授权按钮）以及/或为履行与您之间的合同所必需。</p>
    <h5>（4）信息共享与存储</h5>
    <ul>
      <li><strong>共享：</strong>我们不会将您的手机号码出售、交易或出租给任何第三方用于其独立的营销目的。仅在以下情况下，我们可能会共享您的手机号：
        <ul>
          <li>经过您的明确单独同意。</li>
          <li>根据法律法规规定、诉讼争议解决需要，或行政、司法等有权机关依法提出的要求。</li>
          <li>为保护我们、我们的关联方、合作伙伴或您的合法权益所必需。</li>
          <li>与授权合作伙伴共享：例如物流配送服务商，但我们会要求其严格遵守数据保护协议，并禁止其将信息用于其他任何用途。</li>
        </ul>
      </li>
      <li><strong>存储：</strong>您的手机号码将存储于中华人民共和国境内的服务器上。我们会采取加密等技术措施存储您的手机号，确保其安全。</li>
    </ul>
    <h4>二、 撤销同意与账号注销</h4>
    <h5>1. 撤销同意</h5>
    <p>您有权随时撤销您对手机号收集的授权。您可以通过以下方式操作：</p>
    <ul>
      <li>进入小程序，在【我的】-【设置】-【隐私管理】中关闭手机号授权。</li>
      <li>或通过客服电话/在线客服联系我们，提出撤销授权的请求。</li>
    </ul>
    <p><strong>请注意：</strong>当您撤销同意后，我们将不再处理对应的手机号码。但撤销同意的决定不会影响此前基于您的授权已进行的个人信息处理活动的有效性。同时，这可能导致我们无法继续为您提供依赖于手机号的相关服务（如登录、接收重要通知等）。</p>
    <h5>2. 账号注销</h5>
    <p>如果您决定不再使用我们的服务，您可以申请注销您的账户。注销后，我们将根据适用法律的要求删除或匿名化处理您的个人信息，包括您的手机号码。您可以通过【我的】-【设置】-【账号与安全】-【注销账号】来发起申请。</p>
  </div>
  `)
}

function getServiceAgreementHtml() {
  return compactHtml(`
  <div class="agreement-html-content">
    <p>尊敬的居民朋友：</p>
    <p>您好！</p>
    <p>为进一步促进基本医疗卫生服务均等化，为您提供综合、连续、协同的基本医疗卫生服务，充分发挥家庭医生作为居民健康“守门人”的作用，我们诚挚地邀请您与您的家庭医生团队签订服务协议。在签约前，请您仔细阅读本告知书，充分了解双方的权利和义务。</p>
    <h3>一、什么是家庭医生签约服务？</h3>
    <p>家庭医生签约服务是以全科医生（家庭医生）为核心，以家庭医生团队为支撑，通过签约的方式，与居民（家庭）建立起一种长期、稳定的服务关系，以便为签约居民提供安全、方便、有效、连续、经济的基本医疗、基本公共卫生和健康管理服务。</p>
    <h3>二、您的家庭医生团队</h3>
    <ul>
      <li>家庭医生：（姓名：___________ ， 联系电话：___________）</li>
      <li>社区护士：（姓名：___________ ， 联系电话：___________）</li>
      <li>公卫人员：（姓名：___________ ， 联系电话：___________）</li>
      <li>（可选）其他人员：如康复师、心理咨询师、药师等。</li>
    </ul>
    <h3>三、您享有的主要服务内容（服务包）</h3>
    <p>根据您的健康状况和需求，您签约的服务包为：□ 基础服务包 □ 个性化服务包（具体内容见附件）</p>
    <p>基础服务包通常包括以下内容：</p>
    <ul>
      <li>建立健康档案：为您及家庭成员建立规范的电子健康档案，并及时更新。</li>
      <li>基本医疗服务：
        <ul>
          <li>提供常见病、多发病的一般诊疗服务。</li>
          <li>提供优先预约、就诊服务，帮助您节约候诊时间。</li>
          <li>根据病情需要，提供向上级医院转诊的绿色通道服务。</li>
        </ul>
      </li>
      <li>基本公共卫生服务：
        <ul>
          <li>为65岁以上老年人、高血压、糖尿病、严重精神障碍患者、孕产妇、0-6岁儿童等重点人群提供相应的健康管理服务。</li>
          <li>提供国家免疫规划疫苗接种服务。</li>
          <li>提供传染病防治指导。</li>
        </ul>
      </li>
      <li>健康咨询与指导：
        <ul>
          <li>通过电话、微信、面对面等方式，提供个性化的健康咨询和用药指导。</li>
          <li>提供中医药“治未病”服务。</li>
        </ul>
      </li>
      <li>健康评估与规划：
        <ul>
          <li>每年对您的健康状况进行一次全面评估。</li>
          <li>根据评估结果，制定个性化的健康管理计划。</li>
        </ul>
      </li>
    </ul>
    <p>注：个性化服务包是在基础服务包之上，根据居民特殊需求制定的，可能涉及康复指导、家庭病床、特需上门等服务，并可能按规定收取相关费用。</p>
    <h3>四、作为签约居民，您享有的权利</h3>
    <ul>
      <li>有权获得签约协议所规定的各项服务。</li>
      <li>有权知晓服务的具体内容、流程、收费标准及注意事项。</li>
      <li>在隐私和尊严方面获得尊重和保护，您的个人和家庭信息将被严格保密。</li>
      <li>有权对家庭医生团队的服务质量进行评价和监督，并提出意见和建议。</li>
      <li>在自愿的前提下，有权决定是否签约，并有权了解解约程序。</li>
    </ul>
    <h3>五、作为签约居民，您应履行的义务</h3>
    <ul>
      <li>向家庭医生团队提供真实、有效的个人及家庭健康相关信息。</li>
      <li>积极配合家庭医生团队完成基本公共卫生服务项目和健康管理活动。</li>
      <li>在就医、转诊、康复等方面，遵从家庭医生团队的专业指导意见。</li>
      <li>遵守社区卫生服务中心（站）的相关规章制度和诊疗秩序。</li>
      <li>如联系方式或住址变更，请及时告知您的家庭医生团队。</li>
      <li>按时缴纳约定的服务费用（基础服务包通常由政府补贴，个人免费或支付少量费用；个性化服务包按标准付费）。</li>
    </ul>
    <h3>六、签约周期与解约</h3>
    <p>本协议签约周期原则上为壹年，自 ______ 年 __ 月 __ 日至 ______ 年 __ 月 __ 日。</p>
    <p>期满后，如您和家庭医生均无异议，协议自动续签。</p>
    <p>签约期内，如因您迁居等原因需变更签约机构，或对服务不满意，可凭有效证件到本机构办理解约手续，也可与新选定的机构重新签约，原协议自动终止。</p>
    <h3>七、重要提示</h3>
    <ul>
      <li>家庭医生不是私人医生，其主要职责是为您提供基本医疗卫生服务。</li>
      <li>家庭医生签约服务不能完全替代急诊服务。在遇到紧急、危重病情时，请直接拨打“120”急救电话或前往医院急诊科，以免延误救治。</li>
    </ul>
    <p>本告知书一式两份，居民与社区卫生服务机构各执一份，具有同等效力。</p>
    <p>我已仔细阅读并理解以上《家庭医生签约服务协议告知书》的全部内容，同意并自愿签约。</p>
    <p>签约居民（或法定代理人）签名：___________________</p>
    <p>联系电话：______________________ 日期： 年 月 日</p>
    <p>家庭医生团队代表签名：___________________</p>
    <p>联系电话：______________________ 日期： 年 月 日</p>
    <p>签约机构（盖章）：___________________</p>
    <p>机构地址：___________________</p>
    <p>咨询/监督电话：___________________</p>
    <p>附件： 《个性化服务包具体内容及收费标准》</p>
  </div>
  `)
}

function getSignServiceAgreementHtml() {
  return compactHtml(`
  <div class="sign-service-agreement">
    <p>尊敬的居民朋友：</p>
    <p>您好！</p>
    <p>为进一步促进基本医疗卫生服务均等化，为您提供综合、连续、协同的基本医疗卫生服务，充分发挥家庭医生作为居民健康“守门人”的作用，我们诚挚地邀请您与您的家庭医生团队签订服务协议。在签约前，请您仔细阅读本告知书，充分了解双方的权利和义务。</p>

    <h3>一、什么是家庭医生签约服务？</h3>
    <p>家庭医生签约服务是以全科医生（家庭医生）为核心，以家庭医生团队为支撑，通过签约的方式，与居民（家庭）建立起一种长期、稳定的服务关系，以便为签约居民提供安全、方便、有效、连续、经济的基本医疗、基本公共卫生和健康管理服务。</p>

    <h3>二、您的家庭医生团队</h3>
    <p>为您服务的团队由以下人员组成：</p>
    <ul>
      <li>家庭医生： （姓名：___________ ， 联系电话：___________）</li>
      <li>社区护士： （姓名：___________ ， 联系电话：___________）</li>
      <li>公卫人员： （姓名：___________ ， 联系电话：___________）</li>
      <li>（可选）其他人员： 如康复师、心理咨询师、药师等。</li>
    </ul>

    <h3>三、您享有的主要服务内容（服务包）</h3>
    <p>根据您的健康状况和需求，您签约的服务包为：□ 基础服务包 □ 个性化服务包（具体内容见附件）</p>
    <p>基础服务包通常包括以下内容：</p>
    <ul>
      <li>建立健康档案：为您及家庭成员建立规范的电子健康档案，并及时更新。</li>
      <li>基本医疗服务：
        <ul>
          <li>提供常见病、多发病的一般诊疗服务。</li>
          <li>提供优先预约、就诊服务，帮助您节约候诊时间。</li>
          <li>根据病情需要，提供向上级医院转诊的绿色通道服务。</li>
        </ul>
      </li>
      <li>基本公共卫生服务：
        <ul>
          <li>为65岁以上老年人、高血压、糖尿病、严重精神障碍患者、孕产妇、0-6岁儿童等重点人群提供相应的健康管理服务。</li>
          <li>提供国家免疫规划疫苗接种服务。</li>
          <li>提供传染病防治指导。</li>
        </ul>
      </li>
      <li>健康咨询与指导：
        <ul>
          <li>通过电话、微信、面对面等方式，提供个性化的健康咨询和用药指导。</li>
          <li>提供中医药“治未病”服务。</li>
        </ul>
      </li>
      <li>健康评估与规划：
        <ul>
          <li>每年对您的健康状况进行一次全面评估。</li>
          <li>根据评估结果，制定个性化的健康管理计划。</li>
        </ul>
      </li>
    </ul>
    <p>（注：个性化服务包是在基础服务包之上，根据居民特殊需求制定的，可能涉及康复指导、家庭病床、特需上门等服务，并可能按规定收取相关费用。）</p>

    <h3>四、 作为签约居民，您享有的权利</h3>
    <ul>
      <li>有权获得签约协议所规定的各项服务。</li>
      <li>有权知晓服务的具体内容、流程、收费标准及注意事项。</li>
      <li>在隐私和尊严方面获得尊重和保护，您的个人和家庭信息将被严格保密。</li>
      <li>有权对家庭医生团队的服务质量进行评价和监督，并提出意见和建议。</li>
      <li>在自愿的前提下，有权决定是否签约，并有权了解解约程序。</li>
    </ul>

    <h3>五、作为签约居民，您应履行的义务</h3>
    <ul>
      <li>向家庭医生团队提供真实、有效的个人及家庭健康相关信息。</li>
      <li>积极配合家庭医生团队完成基本公共卫生服务项目和健康管理活动。</li>
      <li>在就医、转诊、康复等方面，遵从家庭医生团队的专业指导意见。</li>
      <li>遵守社区卫生服务中心（站）的相关规章制度和诊疗秩序。</li>
      <li>如联系方式或住址变更，请及时告知您的家庭医生团队。</li>
      <li>按时缴纳约定的服务费用（基础服务包通常由政府补贴，个人免费或支付少量费用；个性化服务包按标准付费）。</li>
    </ul>

    <h3>六、签约周期与解约</h3>
    <p>本协议签约周期原则上为壹年，自 ______ 年 __ 月 __ 日至 ______ 年 __ 月 __ 日。</p>
    <p>期满后，如您和家庭医生均无异议，协议自动续签。</p>
    <p>签约期内，如因您迁居等原因需变更签约机构，或对服务不满意，可凭有效证件到本机构办理解约手续，也可与新选定的机构重新签约，原协议自动终止。</p>

    <h3>七、重要提示</h3>
    <ul>
      <li>家庭医生不是私人医生，其主要职责是为您提供基本医疗卫生服务。</li>
      <li>家庭医生签约服务不能完全替代急诊服务。在遇到紧急、危重病情时，请直接拨打“120”急救电话或前往医院急诊科，以免延误救治。</li>
    </ul>

    <p>本告知书一式两份，居民与社区卫生服务机构各执一份，具有同等效力。</p>
    <p>我已仔细阅读并理解以上《家庭医生签约服务协议告知书》的全部内容，同意并自愿签约。</p>

    <p>签约居民（或法定代理人）签名：___________________</p>
    <p>联系电话：______________________</p>
    <p>日期：          年          月          日</p>

    <p>家庭医生团队代表签名：___________________</p>
    <p>联系电话：______________________</p>
    <p>日期：          年          月          日</p>

    <p>签约机构（盖章）：___________________</p>
    <p>机构地址：___________________</p>
    <p>咨询/监督电话：___________________</p>

    <p>附件： 《个性化服务包具体内容及收费标准》</p>
  </div>
  `)
}
export function useAgreement() {
  function getAgreementContent(type: AgreementType) {
    if (type === 'privacy') {
      return {
        title: '隐私政策',
        html: getPrivacyPolicyHtml(),
      }
    }
    if (type === 'service') {
      return {
        title: '服务协议',
        html: getServiceAgreementHtml(),
      }
    }
    if (type === 'signService') {
      return {
        title: '服务协议',
        html: getSignServiceAgreementHtml(),
      }
    }

    return {
      title: '',
      html: '',
    }
  }

  // 弹窗状态与内容（完善为可直接打开/关闭的 hook）
  const agreementModalShow = ref(false)
  const agreementTitle = ref('')
  const agreementContentHtml = ref('')

  function openAgreementModal(type: AgreementType) {
    const { title, html } = getAgreementContent(type)
    agreementTitle.value = title
    agreementContentHtml.value = html
    agreementModalShow.value = true
  }

  function closeAgreementModal() {
    agreementModalShow.value = false
  }

  return {
    getAgreementContent,
    agreementModalShow,
    agreementTitle,
    agreementContentHtml,
    openAgreementModal,
    closeAgreementModal,
  }
}

export default useAgreement
